<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunarisX Coordinate Cost Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #c9d1d9;
            min-height: 10vh;
            
            /* --- CUSTOM BACKGROUND IMAGE --- */
            background-image: url('https://i.post.cc/0QyD7v2G/black-dark-space-texture.jpg'); 
            background-size: cover;
            background-attachment: fixed; 
            background-position: center;
            background-color: #0d1117; 
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* Adjust background colors for content boxes */
        .bg-gray-800 {
            background-color: rgba(31, 41, 55, 0.9); 
            backdrop-filter: blur(2px); 
        }
        .bg-gray-700, .bg-gray-700\/50, .modal-content {
            background-color: rgba(55, 65, 81, 0.95) !important; 
        }

        /* Custom modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #374151;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        /* Fixed button style */
        #sourceButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 990;
            cursor: pointer;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            background-color: #3b82f6; 
            color: white;
            border-radius: 9999px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s;
        }
        #sourceButton:hover {
            background-color: #2563eb; 
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- HEADER WITH EXAMPLE BUTTON -->
        <div class="flex items-center justify-between mb-6 border-b border-gray-700 pb-2">
            <h1 class="text-3xl font-bold text-green-400">
                LunarisX Coordinate Cost Tool
            </h1>
            <button id="exampleButton" onclick="openExampleModal()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-bold transition duration-200 flex items-center shadow-md shadow-purple-900/50">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18s-3.332.477-4.5 1.247"></path></svg>
                Load User Input Strat
            </button>
        </div>
        
        <p class="text-gray-400 mb-6">
            This tool tracks Tower upgrades using **X and Z coordinates** as the unique identifier and **automatically calculates the current upgrade level** to replace cost placeholders with real game costs.
            <br>
            **Supported cost formats (X, Y, Z are coordinates):**
            <ul class="list-disc list-inside ml-4 mt-2 text-sm text-gray-300">
                <li>Placement: `place(X, Y, Z, "TowerName", <span class="text-red-400">cost</span>)`</li>
                <li>Upgrade: `upgrade(X, Y, Z, <span class="text-red-400">cost</span>)`</li>
            </ul>
            <span class="text-yellow-400 font-medium">Note: The Y-coordinate in `upgrade` calls is ignored for tracking, as X and Z are used for matching.</span>
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Column 1: Input and Settings -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-yellow-400">üìù Input & Settings</h2>

                <!-- Hardcore Mode Toggle -->
                <div class="flex items-center justify-between mb-4 p-3 bg-gray-700 rounded-lg border border-red-500/50">
                    <label for="hardcoreMode" class="text-lg font-bold text-red-400 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Hardcore Mode
                    </label>
                    <input type="checkbox" id="hardcoreMode" class="w-5 h-5 text-red-600 bg-gray-900 border-gray-300 rounded focus:ring-red-500">
                </div>
                
                <label for="inputCode" class="block text-sm font-medium mb-1 text-gray-300">Paste your code (example):</label>
                <!-- Updated placeholder to reflect new input format -->
                <textarea id="inputCode" rows="12" placeholder='place(-23.676, 1.708, -5.151, "Shotgunner", 700)
place(-37.917, 1.927, -6.666, "Shotgunner", 524)
upgrade(-23.676, 3.058, -5.151, 402) -- Shotgunner at -23.676,-5.151 Lvl 1
upgrade(-37.917, 3.277, -6.666, 239) -- Shotgunner at -37.917,-6.666 Lvl 1
upgrade(-37.917, 3.277, -6.666, 1428) -- Shotgunner at -37.917,-6.666 Lvl 2' class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-green-500 focus:border-green-500 mb-4"></textarea>

                <button id="processButton" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold transition duration-200 shadow-md shadow-green-900/50">
                    üîç Lookup & Replace Costs
                </button>
            </div>

            <!-- Column 2: Results -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-blue-400">üí° Results (Modified Code)</h2>
                    <button id="copyButton" onclick="copyOutput()" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition duration-200">
                        Copy All
                    </button>
                </div>
                
                <div id="outputContainer" class="p-4 bg-gray-700 rounded-lg border border-gray-600 min-h-[22rem]">
                    <pre id="outputText" class="text-sm text-gray-200">Paste your code on the left and press the button to see the result.</pre>
                </div>
            </div>
        </div>

        <!-- Tower Placement Cost Table -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-3 text-red-400">‚ö†Ô∏è Tower Placement Costs (Click Tower Name for Upgrade Details)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm rounded-lg overflow-hidden bg-gray-800">
                    <thead>
                        <tr class="bg-gray-700 text-red-300">
                            <th class="p-2 text-left">Tower</th>
                            <th class="p-2 text-right">Normal Cost</th>
                            <th class="p-2 text-right">Hardcore Cost (x1.5)</th>
                        </tr>
                    </thead>
                    <tbody id="costTableBody">
                        <!-- Data populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Floating Source Button -->
    <div id="sourceButton" onclick="openSourceModal()">
        Source Info
    </div>

    <!-- Modal for Upgrade Costs -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-yellow-400">Tower Upgrade Costs</h3>
                <button onclick="closeModal('upgradeModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <table class="min-w-full text-sm rounded-lg overflow-hidden bg-gray-800">
                <thead>
                    <tr class="bg-gray-700 text-red-300">
                        <th class="p-2 text-left">Level</th>
                        <th class="p-2 text-right">Normal Cost</th>
                        <th class="p-2 text-right">Hardcore Cost</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    <!-- Upgrade data goes here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal for Example Strat -->
    <div id="exampleModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 class="text-xl font-bold text-purple-400">üíæ User-Provided Coordinate Strategy</h3>
                <button onclick="closeModal('exampleModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <p class="text-gray-300 mb-4">
                This code demonstrates the `place` and `upgrade` syntax using X, Y, Z coordinates for tower identification.
            </p>
            <button onclick="loadExample(); closeModal('exampleModal');" class="w-full py-2 mb-4 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold transition duration-200">
                Load this Example Code to Input Box
            </button>
            <div class="bg-gray-900 p-3 rounded-lg overflow-x-auto max-h-96">
                <pre id="exampleCodeText" class="text-xs text-gray-300"></pre>
            </div>
        </div>
    </div>

    <!-- Modal for Source Info -->
    <div id="sourceModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 class="text-xl font-bold text-blue-400">Source Information</h3>
                <button onclick="closeModal('sourceModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <p class="text-gray-300 mb-4">This cost replacer tool was created by LunarisX Hub.</p>
            <p class="text-gray-300">
                Join Discord:
                <a href="#" class="text-blue-400 hover:underline font-semibold" onclick="return false;">https://discord.gg/qfENYnhg</a>
            </p>
        </div>
    </div>


    <script>
        // --- TOWER COST DATA ---
        const TOWER_COSTS = {
            "Scout": { "Place": 150, "Upgrade 1": 50, "Upgrade 2": 200, "Upgrade 3": 950, "Upgrade 4": 2500 },
            "Sniper": { "Place": 300, "Upgrade 1": 150, "Upgrade 2": 500, "Upgrade 3": 1500, "Upgrade 4": 4000 },
            "Paintballer": { "Place": 400, "Upgrade 1": 200, "Upgrade 2": 675, "Upgrade 3": 1000, "Upgrade 4": 2250, "Upgrade 5": 4000 },
            "Demoman": { "Place": 575, "Upgrade 1": 150, "Upgrade 2": 475, "Upgrade 3": 1650, "Upgrade 4": 6250 },
            "Hunter": { "Place": 750, "Upgrade 1": 200, "Upgrade 2": 800, "Upgrade 3": 3250, "Upgrade 4": 9400 },
            "Soldier": { "Place": 350, "Upgrade 1": 100, "Upgrade 2": 400, "Upgrade 3": 1500, "Upgrade 4": 4750 },
            "Militant": { "Place": 700, "Upgrade 1": 200, "Upgrade 2": 900, "Upgrade 3": 2750, "Upgrade 4": 9000 },
            "Freezer": { "Place": 425, "Upgrade 1": 225, "Upgrade 2": 650, "Upgrade 3": 2000, "Upgrade 4": 4500 },
            "Assassin": { "Place": 200, "Upgrade 1": 250, "Upgrade 2": 1000, "Upgrade 3": 2750, "Upgrade 4": 7600 },
            "Shotgunner": { "Place": 300, "Upgrade 1": 150, "Upgrade 2": 950, "Upgrade 3": 2500, "Upgrade 4": 6500 },
            "Pyromancer": { "Place": 850, "Upgrade 1": 350, "Upgrade 2": 950, "Upgrade 3": 1500, "Upgrade 4": 3800, "Upgrade 5": 9000 },
            "Ace Pilot": { "Place": 550, "Upgrade 1": 200, "Upgrade 2": 350, "Upgrade 3": 1850, "Upgrade 4": 3200, "Upgrade 5": 8000 },
            "Medic": { "Place": 500, "Upgrade 1": 500, "Upgrade 2": 750, "Upgrade 3": 2700, "Upgrade 4": 6000, "Upgrade 5": 16000 },
            "Farm": { "Place": 250, "Upgrade 1": 200, "Upgrade 2": 550, "Upgrade 3": 1000, "Upgrade 4": 2500, "Upgrade 5": 5000 },
            "Rocketeer": { "Place": 1500, "Upgrade 1": 250, "Upgrade 2": 1750, "Upgrade 3": 6500, "Upgrade 4": 20000 },
            "Trapper": { "Place": 500, "Upgrade 1": 500, "Upgrade 2": 1500, "Upgrade 3": 5000, "Upgrade 4": 13500 },
            "Military Base": { "Place": 400, "Upgrade 1": 200, "Upgrade 2": 400, "Upgrade 3": 1750, "Upgrade 4": 7500, "Upgrade 5": 25000 },
            "Crook Boss": { "Place": 600, "Upgrade 1": 300, "Upgrade 2": 900, "Upgrade 3": 4250, "Upgrade 4": 20000 },
            "Electroshocker": { "Place": 725, "Upgrade 1": 300, "Upgrade 2": 600, "Upgrade 3": 2000, "Upgrade 4": 5000, "Upgrade 5": 15000 },
            "Commander": { "Place": 850, "Upgrade 1": 300, "Upgrade 2": 2500, "Upgrade 3": 5500, "Upgrade 4": 15000 },
            "Warden": { "Place": 1000, "Upgrade 1": 400, "Upgrade 2": 1250, "Upgrade 3": 4500, "Upgrade 4": 15000 },
            "Cowboy": { "Place": 500, "Upgrade 1": 150, "Upgrade 2": 550, "Upgrade 3": 1500, "Upgrade 4": 3000, "Upgrade 5": 5250 },
            "DJ Booth": { "Place": 1200, "Upgrade 1": 300, "Upgrade 2": 1250, "Upgrade 3": 3000, "Upgrade 4": 8000, "Upgrade 5": 20000 },
            "Minigunner": { "Place": 1850, "Upgrade 1": 400, "Upgrade 2": 1500, "Upgrade 3": 7000, "Upgrade 4": 17500 },
            "Ranger": { "Place": 4500, "Upgrade 1": 1500, "Upgrade 2": 4500, "Upgrade 3": 13500, "Upgrade 4": 30000 },
            "Pursuit": { "Place": 3000, "Upgrade 1": 1200, "Upgrade 2": 1850, "Upgrade 3": 5000 },
            "Gatling Gun": { "Place": 5250, "Upgrade 1": 3000, "Upgrade 2": 7500, "Upgrade 3": 15000, "Upgrade 4": 32500, "Upgrade 5": 50000, "Upgrade 6": 100000 },
            "Turret": { "Place": 5000, "Upgrade 1": 1250, "Upgrade 2": 7250, "Upgrade 3": 15000, "Upgrade 4": 30000, "Upgrade 5": 52500 },
            "Mortar": { "Place": 900, "Upgrade 1": 325, "Upgrade 2": 1400, "Upgrade 3": 3250, "Upgrade 4": 12000, "Upgrade 5": 25000 },
            "Mercenary Base": { "Place": 2000, "Upgrade 1": 1000, "Upgrade 2": 2000, "Upgrade 3": 7000, "Upgrade 4": 10000, "Upgrade 5": 15000, "Upgrade 6": 35000 },
            "Brawler": { "Place": 600, "Upgrade 1": 300, "Upgrade 2": 850, "Upgrade 3": 2000, "Upgrade 4": 5000, "Upgrade 5": 12500 },
            "Necromancer": { "Place": 1650, "Upgrade 1": 1150, "Upgrade 2": 3950, "Upgrade 3": 11320, "Upgrade 4": 44000 },
            "Accelerator": { "Place": 4500, "Upgrade 1": 1000, "Upgrade 2": 2500, "Upgrade 3": 4750, "Upgrade 4": 11250, "Upgrade 5": 36000 },
            "Engineer": { "Place": 600, "Upgrade 1": 350, "Upgrade 2": 550, "Upgrade 3": 2250, "Upgrade 4": 4750, "Upgrade 5": 13500, "Upgrade 6": 35000 },
            "Hacker": { "Place": 1400, "Upgrade 1": 600, "Upgrade 2": 1250, "Upgrade 3": 7500, "Upgrade 4": 22000 }
        };

        // Stores the tower state keyed by "X,Z" coordinates (1-based)
        let towerState = {}; 
        
        let outputTextElement;
        let processButton;
        let hardcoreModeCheckbox;
        let inputCodeTextarea;
        let costTableBody;
        let modalTableBody;
        let modalTitle;

        // --- UPDATED EXAMPLE CODE (Using the new coordinate syntax) ---
        const EXAMPLE_CODE = `place(-23.676, 1.708, -5.151, "Shotgunner", 700)
place(-37.917, 1.927, -6.666, "Shotgunner", 524)
upgrade(-23.676, 3.058, -5.151, 402)
upgrade(-37.917, 3.277, -6.666, 239)
upgrade(-37.917, 3.277, -6.666, 1428)
upgrade(-23.676, 3.058, -5.151, 1431)
place(-27.768, 1.989, -3.074, "Electroshocker", 1576)
upgrade(-27.768, 3.339, -3.074, 621)
upgrade(-27.768, 3.339, -3.074, 1037)
place(-28.763, 1.446, -10.221, "Commander", 1856)
place(-25.703, 1.763, -5.269, "Shotgunner", 625)
upgrade(-25.703, 3.113, -5.269, 263)
upgrade(-25.703, 3.113, -5.269, 2078)
place(-22.800, 1.620, -3.144, "Shotgunner", 677)
upgrade(-22.800, 2.970, -3.144, 260)
upgrade(-22.800, 2.970, -3.144, 1433)
place(-24.891, 1.847, -3.229, "Shotgunner", 1418)
upgrade(-24.891, 3.197, -3.229, 968)
upgrade(-24.891, 3.197, -3.229, 1993)
place(-25.450, 1.621, -0.725, "Freezer", 788)
upgrade(-25.450, 2.971, -0.725, 391)
upgrade(-25.450, 2.971, -0.725, 1334)
place(-30.449, 1.950, -4.334, "Shotgunner", 434)
place(-30.480, 1.955, -4.280, "Shotgunner", 460)
upgrade(-30.480, 3.305, -4.280, 473)
upgrade(-30.480, 3.305, -4.280, 2998)
place(-22.551, 1.520, -0.970, "Shotgunner", 1933)
upgrade(-22.551, 2.870, -0.970, 1483)
upgrade(-22.551, 2.870, -0.970, 1618)
upgrade(-28.763, 3.146, -10.221, 1413)
upgrade(-28.763, 3.146, -10.221, 964)
upgrade(-28.763, 3.146, -10.221, 3776)`;


        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            outputTextElement = document.getElementById('outputText');
            processButton = document.getElementById('processButton');
            hardcoreModeCheckbox = document.getElementById('hardcoreMode');
            inputCodeTextarea = document.getElementById('inputCode');
            costTableBody = document.getElementById('costTableBody');
            modalTableBody = document.getElementById('modalTableBody');
            modalTitle = document.getElementById('modalTitle');

            // Set up event listeners
            processButton.addEventListener('click', processCode);
            hardcoreModeCheckbox.addEventListener('change', processCode);

            // Populate the Tower Cost Table on load
            populateTable();
        });
        
        // --- UTILITY FUNCTIONS ---

        /**
         * Safely calculates the cost (with Hardcore multiplier).
         * @param {number} cost - The base cost.
         * @returns {number} The calculated cost.
         */
        function getCost(cost) {
            const isHardcore = hardcoreModeCheckbox.checked;
            return isHardcore ? Math.ceil(cost * 1.5) : cost;
        }

        /**
         * Renders the main table of tower placement costs.
         */
        function populateTable() {
            costTableBody.innerHTML = '';
            const sortedTowerNames = Object.keys(TOWER_COSTS).sort();

            sortedTowerNames.forEach(towerName => {
                const normalCost = TOWER_COSTS[towerName].Place;
                const hardcoreCost = getCost(normalCost);

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700/50 cursor-pointer transition duration-150 border-t border-gray-700';
                row.innerHTML = `
                    <td class="p-2 font-bold text-yellow-300" onclick="openUpgradeModal('${towerName}')">${towerName}</td>
                    <td class="p-2 text-right text-gray-200">$${normalCost.toLocaleString()}</td>
                    <td class="p-2 text-right text-red-400">$${hardcoreCost.toLocaleString()}</td>
                `;
                costTableBody.appendChild(row);
            });
        }

        /**
         * Calculates the cost for a given tower and target level.
         * @param {string} towerName 
         * @param {number} targetLevel 
         * @returns {number | null} The cost or null if level is out of bounds.
         */
        function calculateUpgradeCost(towerName, targetLevel) {
            const towerData = TOWER_COSTS[towerName];
            if (!towerData) return null;

            if (targetLevel === 0) {
                return towerData.Place;
            }

            const upgradeKey = `Upgrade ${targetLevel}`;
            const baseCost = towerData[upgradeKey];
            
            if (baseCost !== undefined) {
                return getCost(baseCost);
            }
            return null; // Upgrade level not found
        }
        
        // --- MAIN PROCESSING LOGIC ---

        /**
         * Processes the input code line by line, tracking tower states by X,Z coordinates
         * and replacing cost placeholders.
         */
        function processCode() {
            // Reset state for new run
            towerState = {}; 
            
            const lines = inputCodeTextarea.value.split('\n');
            const processedLines = [];
            let errorFound = false;

            // Regex for matching the new coordinate functions
            // Group 1: Function name (place or upgrade)
            // Group 2: X-coord
            // Group 3: Y-coord
            // Group 4: Z-coord
            // Group 5: Tower Name (only for place) / Cost (for both)
            // Group 6: Cost (only for place)
            const placeRegex = /(place)\s*\(([^,]+),\s*([^,]+),\s*([^,]+),\s*["']([^"']+)["'],\s*([a-zA-Z0-9_\'"]+)\s*\)/;
            const upgradeRegex = /(upgrade)\s*\(([^,]+),\s*([^,]+),\s*([^,]+),\s*([a-zA-Z0-9_\'"]+)\s*\)/;
            
            lines.forEach((originalLine, index) => {
                let line = originalLine.trim();
                let match;
                let processedLine = originalLine;
                const lineNumber = index + 1;

                if (line.startsWith('place')) {
                    match = line.match(placeRegex);
                    
                    if (match) {
                        const [, funcName, x, y, z, towerName, costPlaceholder] = match;
                        
                        // Use X and Z as the unique identifier key
                        const key = `${x},${z}`;
                        
                        // Check if the tower name is valid
                        if (!TOWER_COSTS[towerName]) {
                            processedLine = `// ‚ö†Ô∏è ERROR L${lineNumber}: Unknown tower: "${towerName}"\n${originalLine}`;
                            errorFound = true;
                        } else if (towerState[key]) {
                            processedLine = `// ‚ö†Ô∏è WARNING L${lineNumber}: Tower at ${key} already exists. Resetting level.\n${originalLine}`;
                            towerState[key].level = 0; // Overwrite if duplicate placement is found
                        } else {
                            // Initial placement
                            towerState[key] = { name: towerName, level: 0 };
                        }

                        // Calculate placement cost (Level 0)
                        const cost = calculateUpgradeCost(towerName, 0);
                        if (cost !== null) {
                            processedLine = originalLine.replace(costPlaceholder, cost.toLocaleString());
                        } else {
                            processedLine = `// ‚ö†Ô∏è ERROR L${lineNumber}: Could not find base cost for ${towerName}\n${originalLine}`;
                            errorFound = true;
                        }
                    } else if (line.includes('place')) {
                        processedLine = `// ‚ö†Ô∏è SYNTAX ERROR L${lineNumber}: Cannot parse 'place' command. Check arguments.\n${originalLine}`;
                        errorFound = true;
                    }

                } else if (line.startsWith('upgrade')) {
                    match = line.match(upgradeRegex);

                    if (match) {
                        // For upgrade, we use the coordinates to find the existing tower state
                        const [, funcName, x, y, z, costPlaceholder] = match;
                        const key = `${x},${z}`;

                        if (towerState[key]) {
                            const tower = towerState[key];
                            const nextLevel = tower.level + 1;
                            const towerName = tower.name;

                            const cost = calculateUpgradeCost(towerName, nextLevel);
                            
                            if (cost !== null) {
                                processedLine = originalLine.replace(costPlaceholder, cost.toLocaleString());
                                tower.level = nextLevel; // Update state
                            } else {
                                processedLine = `// ‚ö†Ô∏è ERROR L${lineNumber}: Max level reached for ${towerName} at ${key} (tried Lvl ${nextLevel}).\n${originalLine}`;
                                errorFound = true;
                            }
                        } else {
                            processedLine = `// ‚ö†Ô∏è ERROR L${lineNumber}: No tower found at coordinates X:${x}, Z:${z} to upgrade.\n${originalLine}`;
                            errorFound = true;
                        }
                    } else if (line.includes('upgrade')) {
                        processedLine = `// ‚ö†Ô∏è SYNTAX ERROR L${lineNumber}: Cannot parse 'upgrade' command. Check arguments.\n${originalLine}`;
                        errorFound = true;
                    }
                }
                
                processedLines.push(processedLine);
            });

            outputTextElement.textContent = processedLines.join('\n');
            
            if (errorFound) {
                 outputTextElement.textContent = `// Processing finished with ERRORS. Check the annotated lines below.\n\n` + outputTextElement.textContent;
            } else if (processedLines.length > 0) {
                 outputTextElement.textContent = `// Successfully processed ${processedLines.length} lines.\n\n` + outputTextElement.textContent;
            }
        }


        // --- MODAL AND UI FUNCTIONS ---
        
        /**
         * Copies the output text to the clipboard.
         */
        function copyOutput() {
            const outputText = outputTextElement.textContent;
            if (outputText === "Paste your code on the left and press the button to see the result.") {
                return;
            }
            // Use execCommand('copy') as navigator.clipboard may not work in iframes
            const textarea = document.createElement('textarea');
            textarea.value = outputText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            // Simple visual feedback
            const copyButton = document.getElementById('copyButton');
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = 'Copy All';
            }, 1500);
        }

        /**
         * Opens the modal to show upgrade costs for a specific tower.
         * @param {string} towerName 
         */
        function openUpgradeModal(towerName) {
            modalTitle.textContent = `${towerName} Upgrade Costs`;
            modalTableBody.innerHTML = '';
            
            const towerData = TOWER_COSTS[towerName];
            if (!towerData) return;

            // Placement cost
            let row = document.createElement('tr');
            row.className = 'border-t border-gray-700 bg-gray-700 font-bold';
            row.innerHTML = `
                <td class="p-2 text-left">Placement (Lvl 0)</td>
                <td class="p-2 text-right">$${towerData.Place.toLocaleString()}</td>
                <td class="p-2 text-right text-red-400">$${getCost(towerData.Place).toLocaleString()}</td>
            `;
            modalTableBody.appendChild(row);

            // Upgrade costs
            for (let i = 1; i <= Object.keys(towerData).length - 1; i++) {
                const upgradeKey = `Upgrade ${i}`;
                const normalCost = towerData[upgradeKey];
                
                if (normalCost !== undefined) {
                    const hardcoreCost = getCost(normalCost);
                    row = document.createElement('tr');
                    row.className = 'border-t border-gray-700 hover:bg-gray-700/50';
                    row.innerHTML = `
                        <td class="p-2 text-left">Level ${i}</td>
                        <td class="p-2 text-right">$${normalCost.toLocaleString()}</td>
                        <td class="p-2 text-right text-red-400">$${hardcoreCost.toLocaleString()}</td>
                    `;
                    modalTableBody.appendChild(row);
                }
            }
            document.getElementById('upgradeModal').style.display = 'block';
        }

        /**
         * Closes a specified modal.
         * @param {string} id - The ID of the modal to close.
         */
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        /**
         * Opens the modal containing the example code.
         */
        function openExampleModal() {
            document.getElementById('exampleCodeText').textContent = EXAMPLE_CODE;
            document.getElementById('exampleModal').style.display = 'block';
        }

        /**
         * Loads the example code into the input textarea.
         */
        function loadExample() {
            inputCodeTextarea.value = EXAMPLE_CODE;
            processCode(); // Automatically process the loaded code
        }
        
        /**
         * Opens the source info modal.
         */
        function openSourceModal() {
             document.getElementById('sourceModal').style.display = 'block';
        }
        
        // Close modals if the user clicks outside of them
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>

