<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunarisX Cost Tool (Coordinate Tracker)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #c9d1d9;
            min-height: 10vh;
            
            /* --- CUSTOM BACKGROUND IMAGE --- */
            background-image: url('https://i.post.cc/0QyD7v2G/black-dark-space-texture.jpg'); 
            background-size: cover;
            background-attachment: fixed; 
            background-position: center;
            background-color: #0d1117; 
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* Adjust background colors for content boxes */
        .bg-gray-800 {
            background-color: rgba(31, 41, 55, 0.9); 
            backdrop-filter: blur(2px); 
        }
        .bg-gray-700, .bg-gray-700\/50, .modal-content {
            background-color: rgba(55, 65, 81, 0.95) !important; 
        }

        /* Custom modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #374151;
            width: 90%;
            max-width: 600px; 
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        /* Fixed button style */
        #sourceButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 990;
            cursor: pointer;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            background-color: #3b82f6; 
            color: white;
            border-radius: 9999px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s;
        }
        #sourceButton:hover {
            background-color: #2563eb; 
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- HEADER WITH EXAMPLE BUTTON -->
        <div class="flex items-center justify-between mb-6 border-b border-gray-700 pb-2">
            <h1 class="text-3xl font-bold text-green-400">
                LunarisX Cost Tool (Coordinate Tracking)
            </h1>
            <button id="exampleButton" onclick="openExampleModal()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-bold transition duration-200 flex items-center shadow-md shadow-purple-900/50">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18s-3.332.477-4.5 1.247"></path></svg>
                Example Strat
            </button>
        </div>
        
        <p class="text-gray-400 mb-6">
            This tool now tracks towers using their **X, Z coordinates** to accurately determine upgrade levels and replace costs.
            <br>
            **Supported cost formats:**
            <ul class="list-disc list-inside ml-4 mt-2 text-sm text-gray-300">
                <li>Place: `place(X, Y, Z, "TowerName", cost)`</li>
                <li>Upgrade: `upgrade(X, Y, Z, cost)`</li>
            </ul>
            <p class="text-xs text-red-300 mt-2">
                ‚ö†Ô∏è **Note:** We use the X and Z coordinates (rounded to 2 decimal places) from the `place` call as the unique identifier for each tower, ensuring upgrades are correctly applied even if the Y coordinate changes.
            </p>
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Column 1: Input and Settings -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-yellow-400">üìù Input & Settings</h2>

                <!-- Hardcore Mode Toggle -->
                <div class="flex items-center justify-between mb-4 p-3 bg-gray-700 rounded-lg border border-red-500/50">
                    <label for="hardcoreMode" class="text-lg font-bold text-red-400 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Hardcore Mode
                    </label>
                    <input type="checkbox" id="hardcoreMode" class="w-5 h-5 text-red-600 bg-gray-900 border-gray-300 rounded focus:ring-red-500">
                </div>
                
                <label for="inputCode" class="block text-sm font-medium mb-1 text-gray-300">Paste your code:</label>
                <textarea id="inputCode" rows="10" placeholder='place(-23.676, 1.708, -5.151, "Shotgunner", cost)
upgrade(-23.676, 3.058, -5.151, cost)
upgrade(-23.676, 3.058, -5.151, cost) 
place(-27.768, 1.989, -3.074, "Electroshocker", cost)
upgrade(-27.768, 3.339, -3.074, cost)' class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-green-500 focus:border-green-500 mb-4"></textarea>

                <button id="processButton" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold transition duration-200 shadow-md shadow-green-900/50">
                    üîç Lookup & Replace Costs
                </button>
                
                <!-- Removed Duplication Tool -->
            </div>

            <!-- Column 2: Results -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-blue-400">üí° Results (Modified Code)</h2>
                    <button id="copyButton" onclick="copyOutput()" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition duration-200">
                        Copy All
                    </button>
                </div>
                
                <div id="outputContainer" class="p-4 bg-gray-700 rounded-lg border border-gray-600 min-h-[22rem]">
                    <pre id="outputText" class="text-sm text-gray-200">Paste your code on the left and press the button to see the result.</pre>
                </div>
            </div>
        </div>

        <!-- Tower Placement Cost Table -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-3 text-red-400">‚ö†Ô∏è Tower Placement Costs (Click Tower Name for Upgrade Details)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm rounded-lg overflow-hidden bg-gray-800">
                    <thead>
                        <tr class="bg-gray-700 text-red-300">
                            <th class="p-2 text-left">Tower</th>
                            <th class="p-2 text-right">Normal Cost</th>
                            <th class="p-2 text-right">Hardcore Cost (x1.5)</th>
                        </tr>
                    </thead>
                    <tbody id="costTableBody">
                        <!-- Data populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Floating Source Button -->
    <div id="sourceButton" onclick="openSourceModal()">
        Source Info
    </div>

    <!-- Modal for Upgrade Costs -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-yellow-400">Tower Upgrade Costs</h3>
                <button onclick="closeModal('upgradeModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <table class="min-w-full text-sm rounded-lg overflow-hidden bg-gray-800">
                <thead>
                    <tr class="bg-gray-700 text-red-300">
                        <th class="p-2 text-left">Level</th>
                        <th class="p-2 text-right">Normal Cost</th>
                        <th class="p-2 text-right">Hardcore Cost</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    <!-- Upgrade data goes here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- NEW Modal for Example Strat -->
    <div id="exampleModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 class="text-xl font-bold text-purple-400">üçï Lvl 1 Tower Placement Example</h3>
                <button onclick="closeModal('exampleModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <p class="text-gray-300 mb-4">
                This example shows the placement and first upgrade (Lvl 1) for a few towers using the new coordinate format.
            </p>
            <button onclick="loadExample(); closeModal('exampleModal');" class="w-full py-2 mb-4 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold transition duration-200">
                Load this Example Code to Input Box
            </button>
            <div class="bg-gray-900 p-3 rounded-lg overflow-x-auto max-h-96">
                <pre id="exampleCodeText" class="text-xs text-gray-300"></pre>
            </div>
        </div>
    </div>

    <!-- Modal for Source Info -->
    <div id="sourceModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 class="text-xl font-bold text-blue-400">Source Information</h3>
                <button onclick="closeModal('sourceModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <p class="text-gray-300 mb-4">This cost replacer tool was created by LunarisX Hub.</p>
            <p class="text-gray-300">
                Join Discord:
                <a href="#" class="text-blue-400 hover:underline font-semibold" onclick="return false;">https://discord.gg/qfENYnhg</a>
            </p>
        </div>
    </div>


    <script>
        // --- TOWER COST DATA ---
        const TOWER_COSTS = {
            "Scout": { "Place": 150, "Upgrade 1": 50, "Upgrade 2": 200, "Upgrade 3": 950, "Upgrade 4": 2500 },
            "Sniper": { "Place": 300, "Upgrade 1": 150, "Upgrade 2": 500, "Upgrade 3": 1500, "Upgrade 4": 4000 },
            "Paintballer": { "Place": 400, "Upgrade 1": 200, "Upgrade 2": 675, "Upgrade 3": 1000, "Upgrade 4": 2250, "Upgrade 5": 4000 },
            "Demoman": { "Place": 575, "Upgrade 1": 150, "Upgrade 2": 475, "Upgrade 3": 1650, "Upgrade 4": 6250 },
            "Hunter": { "Place": 750, "Upgrade 1": 200, "Upgrade 2": 800, "Upgrade 3": 3250, "Upgrade 4": 9400 },
            "Soldier": { "Place": 350, "Upgrade 1": 100, "Upgrade 2": 400, "Upgrade 3": 1500, "Upgrade 4": 4750 },
            "Militant": { "Place": 700, "Upgrade 1": 200, "Upgrade 2": 900, "Upgrade 3": 2750, "Upgrade 4": 9000 },
            "Freezer": { "Place": 425, "Upgrade 1": 225, "Upgrade 2": 650, "Upgrade 3": 2000, "Upgrade 4": 4500 },
            "Assassin": { "Place": 200, "Upgrade 1": 250, "Upgrade 2": 1000, "Upgrade 3": 2750, "Upgrade 4": 7600 },
            "Shotgunner": { "Place": 300, "Upgrade 1": 150, "Upgrade 2": 950, "Upgrade 3": 2500, "Upgrade 4": 6500 },
            "Pyromancer": { "Place": 850, "Upgrade 1": 350, "Upgrade 2": 950, "Upgrade 3": 1500, "Upgrade 4": 3800, "Upgrade 5": 9000 },
            "Ace Pilot": { "Place": 550, "Upgrade 1": 200, "Upgrade 2": 350, "Upgrade 3": 1850, "Upgrade 4": 3200, "Upgrade 5": 8000 },
            "Medic": { "Place": 500, "Upgrade 1": 500, "Upgrade 2": 750, "Upgrade 3": 2700, "Upgrade 4": 6000, "Upgrade 5": 16000 },
            "Farm": { "Place": 250, "Upgrade 1": 200, "Upgrade 2": 550, "Upgrade 3": 1000, "Upgrade 4": 2500, "Upgrade 5": 5000 },
            "Rocketeer": { "Place": 1500, "Upgrade 1": 250, "Upgrade 2": 1750, "Upgrade 3": 6500, "Upgrade 4": 20000 },
            "Trapper": { "Place": 500, "Upgrade 1": 500, "Upgrade 2": 1500, "Upgrade 3": 5000, "Upgrade 4": 13500 },
            "Military Base": { "Place": 400, "Upgrade 1": 200, "Upgrade 2": 400, "Upgrade 3": 1750, "Upgrade 4": 7500, "Upgrade 5": 25000 },
            "Crook Boss": { "Place": 600, "Upgrade 1": 300, "Upgrade 2": 900, "Upgrade 3": 4250, "Upgrade 4": 20000 },
            "Electroshocker": { "Place": 725, "Upgrade 1": 300, "Upgrade 2": 600, "Upgrade 3": 2000, "Upgrade 4": 5000, "Upgrade 5": 15000 },
            "Commander": { "Place": 850, "Upgrade 1": 300, "Upgrade 2": 2500, "Upgrade 3": 5500, "Upgrade 4": 15000 },
            "Warden": { "Place": 1000, "Upgrade 1": 400, "Upgrade 2": 1250, "Upgrade 3": 4500, "Upgrade 4": 15000 },
            "Cowboy": { "Place": 500, "Upgrade 1": 150, "Upgrade 2": 550, "Upgrade 3": 1500, "Upgrade 4": 3000, "Upgrade 5": 5250 },
            "DJ Booth": { "Place": 1200, "Upgrade 1": 300, "Upgrade 2": 1250, "Upgrade 3": 3000, "Upgrade 4": 8000, "Upgrade 5": 20000 },
            "Minigunner": { "Place": 1850, "Upgrade 1": 400, "Upgrade 2": 1500, "Upgrade 3": 7000, "Upgrade 4": 17500 },
            "Ranger": { "Place": 4500, "Upgrade 1": 1500, "Upgrade 2": 4500, "Upgrade 3": 13500, "Upgrade 4": 30000 },
            "Pursuit": { "Place": 3000, "Upgrade 1": 1200, "Upgrade 2": 1850, "Upgrade 3": 5000 },
            "Gatling Gun": { "Place": 5250, "Upgrade 1": 3000, "Upgrade 2": 7500, "Upgrade 3": 15000, "Upgrade 4": 32500, "Upgrade 5": 50000, "Upgrade 6": 100000 },
            "Turret": { "Place": 5000, "Upgrade 1": 1250, "Upgrade 2": 7250, "Upgrade 3": 15000, "Upgrade 4": 30000, "Upgrade 5": 52500 },
            "Mortar": { "Place": 900, "Upgrade 1": 325, "Upgrade 2": 1400, "Upgrade 3": 3250, "Upgrade 4": 12000, "Upgrade 5": 25000 },
            "Mercenary Base": { "Place": 2000, "Upgrade 1": 1000, "Upgrade 2": 2000, "Upgrade 3": 7000, "Upgrade 4": 10000, "Upgrade 5": 15000, "Upgrade 6": 35000 },
            "Brawler": { "Place": 600, "Upgrade 1": 300, "Upgrade 2": 850, "Upgrade 3": 2000, "Upgrade 4": 5000, "Upgrade 5": 12500 },
            "Necromancer": { "Place": 1650, "Upgrade 1": 1150, "Upgrade 2": 3950, "Upgrade 3": 11320, "Upgrade 4": 44000 },
            "Accelerator": { "Place": 4500, "Upgrade 1": 1000, "Upgrade 2": 2500, "Upgrade 3": 4750, "Upgrade 4": 11250, "Upgrade 5": 36000 },
            "Engineer": { "Place": 600, "Upgrade 1": 350, "Upgrade 2": 550, "Upgrade 3": 2250, "Upgrade 4": 4750, "Upgrade 5": 13500, "Upgrade 6": 35000 },
            "Hacker": { "Place": 1400, "Upgrade 1": 600, "Upgrade 2": 1250, "Upgrade 3": 7500, "Upgrade 4": 22000 }
        };

        // Stores the tower info mapped to its unique coordinate key (X_rounded, Z_rounded)
        let towerCoordsMap = {}; 
        
        let outputTextElement;
        let processButton;
        let hardcoreModeCheckbox;
        let inputCodeTextarea;
        let costTableBody;
        let modalTableBody;
        let modalTitle;
        
        // --- EXAMPLE CODE (Using the new coordinate format) ---
        const EXAMPLE_CODE = `place(-23.68, 1.71, -5.15, "Shotgunner", cost)
place(-37.92, 1.93, -6.67, "Shotgunner", cost)
upgrade(-23.68, 3.06, -5.15, cost)
upgrade(-37.92, 3.28, -6.67, cost)
upgrade(-37.92, 3.28, -6.67, cost)
upgrade(-23.68, 3.06, -5.15, cost)
place(-27.77, 1.99, -3.07, "Electroshocker", cost)
upgrade(-27.77, 3.34, -3.07, cost)
upgrade(-27.77, 3.34, -3.07, cost)
place(-28.76, 1.45, -10.22, "Commander", cost)
place(-25.70, 1.76, -5.27, "Shotgunner", cost)
upgrade(-25.70, 3.11, -5.27, cost)
upgrade(-25.70, 3.11, -5.27, cost)
place(-22.80, 1.62, -3.14, "Shotgunner", cost)
upgrade(-22.80, 2.97, -3.14, cost)
upgrade(-22.80, 2.97, -3.14, cost)
place(-24.89, 1.85, -3.23, "Shotgunner", cost)
upgrade(-24.89, 3.20, -3.23, cost)
upgrade(-24.89, 3.20, -3.23, cost)
place(-25.45, 1.62, -0.73, "Freezer", cost)
upgrade(-25.45, 2.97, -0.73, cost)
upgrade(-25.45, 2.97, -0.73, cost)
place(-30.45, 1.95, -4.33, "Shotgunner", cost)
place(-30.48, 1.96, -4.28, "Shotgunner", cost)
upgrade(-30.48, 3.31, -4.28, cost)
upgrade(-30.48, 3.31, -4.28, cost)
place(-22.55, 1.52, -0.97, "Shotgunner", cost)
upgrade(-22.55, 2.87, -0.97, cost)
upgrade(-22.55, 2.87, -0.97, cost)
upgrade(-28.76, 3.15, -10.22, cost)
upgrade(-28.76, 3.15, -10.22, cost)
upgrade(-28.76, 3.15, -10.22, cost)`;
        // --- END EXAMPLE CODE ---

        /**
         * Rounds a coordinate string to 2 decimal places for reliable key generation.
         */
        const roundCoord = (coordStr) => {
            return parseFloat(coordStr.trim()).toFixed(2);
        };
        
        /**
         * Calculates the unique coordinate key (X_rounded, Z_rounded).
         * @param {string} xStr - X coordinate string.
         * @param {string} zStr - Z coordinate string.
         * @returns {string} The unique key "X,Z".
         */
        const getCoordKey = (xStr, zStr) => {
            return `${roundCoord(xStr)},${roundCoord(zStr)}`;
        }


        /**
         * Calculates the Hardcore Cost (1.5x rounded up to the nearest integer).
         */
        const getHardcoreCost = (baseCost) => Math.ceil(baseCost * 1.5); 

        /**
         * Looks up the cost based on tower name and type (Place or Upgrade X).
         */
        function lookupCost(towerName, costType, isHardcore) {
            const towerData = TOWER_COSTS[towerName];
            if (!towerData) return null;

            const baseCost = towerData[costType];
            if (baseCost === undefined) return null;

            return isHardcore ? getHardcoreCost(baseCost) : baseCost;
        }
        
        // Regex for place(X, Y, Z, "TowerName", cost)
        const getPlaceRegex = () => {
             // G1: Full prefix including 'place('
             // G2: X
             // G3: Y
             // G4: Z
             // G5: Tower Name
             // G6: Cost Placeholder (cost or "cost" or number)
             // G7: Suffix/End
             return /(\s*place\s*\()([^,]+),\s*([^,]+),\s*([^,]+),\s*["']([^"']+)["'],\s*["']?([cC][oO][sS][t]|\d+)'?(\s*\))/i;
        };

        // Regex for upgrade(X, Y, Z, cost)
        const getUpgradeRegex = () => {
             // G1: Full prefix including 'upgrade('
             // G2: X
             // G3: Y
             // G4: Z
             // G5: Cost Placeholder (cost or "cost" or number)
             // G6: Suffix/End
            return /(\s*upgrade\s*\()([^,]+),\s*([^,]+),\s*([^,]+),\s*["']?([cC][oO][sS][t]|\d+)'?(\s*\))/i;
        };


        /**
         * Pre-scans the input code to map the unique (X, Z) coordinates of place commands to the tower name.
         */
        function preProcessPlaceCommands(inputCode) {
            towerCoordsMap = {};
            const placeRegex = getPlaceRegex();
            const lines = inputCode.split('\n');

            lines.forEach(line => {
                // Only process lines that contain the place function call and are not commented out
                if (line.toLowerCase().includes('place(') && !line.trim().startsWith('--') && !line.trim().startsWith('//')) {
                    
                    const placeMatch = line.match(placeRegex);
                    
                    if (placeMatch) {
                        const xStr = placeMatch[2];
                        const zStr = placeMatch[4];
                        const towerName = placeMatch[5].trim();
                        
                        const key = getCoordKey(xStr, zStr);

                        if (towerName && !towerCoordsMap[key]) {
                            // Map the unique X,Z coordinates to tower data, initialize upgrade level
                            towerCoordsMap[key] = {
                                towerName: towerName,
                                upgradeLevel: 0
                            };
                        }
                    }
                }
            });
            // console.log("Tower Coords Map:", towerCoordsMap);
        }

        /**
         * The main function to process the input code string.
         */
        function processCode(inputCode, isHardcore) {
            
            if (inputCode.trim() === '') {
                 return "‚ùå ERROR: Invalid format. Input cannot be empty.";
            }

            // Step 1: Pre-process the code to map unique X,Z coordinates to tower names
            preProcessPlaceCommands(inputCode);
            
            let outputCode = '';
            let matchesFound = 0;
            let totalCost = 0; 
            
            // Create a temporary, writable copy of the map for upgrade tracking during processing
            const activeTowerTracker = JSON.parse(JSON.stringify(towerCoordsMap));

            const placeRegex = getPlaceRegex();
            const upgradeRegex = getUpgradeRegex();

            const lines = inputCode.split('\n');

            lines.forEach(line => {
                // Skip comments
                if (line.trim().startsWith('--') || line.trim().startsWith('//')) {
                    outputCode += line + '\n';
                    return;
                }
                
                let processedLine = line;

                // --- 1. PROCESS place(X, Y, Z, "TowerName", cost) ---
                if (line.toLowerCase().includes('place(')) {
                    const placeMatch = line.match(placeRegex);
                    
                    if (placeMatch) {
                        const xStr = placeMatch[2];
                        const zStr = placeMatch[4];
                        const towerName = placeMatch[5].trim(); 
                        
                        // Use the key derived from the X, Z coords
                        const key = getCoordKey(xStr, zStr);
                        const finalCost = lookupCost(towerName, "Place", isHardcore);
                        
                        processedLine = line.replace(placeRegex, (match, prefix, x, y, z, name, costPlaceholder, endSuffix) => {
                             if (finalCost !== null) {
                                matchesFound++;
                                totalCost += finalCost; 
                                // Return the full line with the cost placeholder (G6) replaced by the numeric cost
                                return `${prefix}${x}, ${y}, ${z}, "${name}", ${finalCost}${endSuffix}`;
                            } else {
                                console.warn(`[Place] Tower name not found or cost missing: ${towerName}`);
                                return match; 
                            }
                        });
                    }
                }

                // --- 2. PROCESS upgrade(X, Y, Z, cost) ---
                else if (line.toLowerCase().includes('upgrade(')) {
                    const upgradeMatch = line.match(upgradeRegex);

                    if (upgradeMatch) {
                        
                        const xStr = upgradeMatch[2];
                        const zStr = upgradeMatch[4];
                        const costPlaceholder = upgradeMatch[5];
                        
                        // Use the key derived from the X, Z coords for lookup
                        const key = getCoordKey(xStr, zStr);
                        const towerInfo = activeTowerTracker[key];
                        
                        if (towerInfo) {
                            // Increment counter for this tower
                            towerInfo.upgradeLevel++;
                            const currentLevel = towerInfo.upgradeLevel;
                            
                            const towerName = towerInfo.towerName;
                            const costType = `Upgrade ${currentLevel}`;
                            const finalCost = lookupCost(towerName, costType, isHardcore);
                            
                            if (finalCost !== null) {
                                matchesFound++;
                                totalCost += finalCost; 
                                
                                processedLine = line.replace(upgradeRegex, (match, prefix, x, y, z, costPlaceholder, endSuffix) => {
                                    // Replace the cost placeholder (G5) with the numeric cost
                                    return `${prefix}${x}, ${y}, ${z}, ${finalCost}${endSuffix}`;
                                });

                            } else {
                                // Max level reached or cost not defined. Revert counter and warn.
                                console.warn(`[Upgrade] Max level reached or cost not defined for ${towerName} at X:${roundCoord(xStr)}, Z:${roundCoord(zStr)} (Level ${currentLevel}). Skipping.`);
                                towerInfo.upgradeLevel--; 
                            }
                        } else {
                            console.warn(`[Upgrade] Tower not found at X:${roundCoord(xStr)}, Z:${roundCoord(zStr)} in placement map.`);
                        }
                    }
                }

                outputCode += processedLine + '\n';
            }); 

            // Final processing/cleanup
            outputCode = outputCode.trim();
            const costModeText = isHardcore ? "Hardcore" : "Normal";
            
            // Add total cost to the top of the output
            outputCode = `// --- TOTAL COST (${costModeText}): ${totalCost.toLocaleString()} ---\n` + outputCode;


            if (matchesFound === 0) {
                 return "‚ö†Ô∏è WARNING: No valid 'place' or 'upgrade' commands found. Please check format.";
            }
            
            return outputCode;
        }
        
        // --- CLIPBOARD FUNCTIONALITY (Same as before) ---

        /**
         * Fallback mechanism using document.execCommand('copy')
         */
        function fallbackCopy(text, button, originalText) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.left = '-9999px';
            tempTextArea.style.top = '0';

            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    button.textContent = 'Copied! ‚úÖ';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 1500);
                } else {
                    button.textContent = 'Failed ‚ùå';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                }
            } catch (err) {
                button.textContent = 'Error ‚ùå';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }

            document.body.removeChild(tempTextArea);
        }
        
        /**
         * Copies the content of the outputText pre element to the clipboard.
         */
        function copyOutput() {
            const textToCopy = outputTextElement.textContent;
            const copyButton = document.getElementById('copyButton');
            const originalText = 'Copy All';

            if (textToCopy.includes("Paste your code") || textToCopy.includes("No valid")) {
                 copyButton.textContent = 'No code to copy!';
                 setTimeout(() => { copyButton.textContent = originalText; }, 2000);
                 return;
            }

            // 1. Try modern clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        copyButton.textContent = 'Copied! ‚úÖ';
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                        }, 1500);
                    })
                    .catch(err => {
                        // 2. Fallback
                        fallbackCopy(textToCopy, copyButton, originalText);
                    });
            } else {
                // 2. Fallback for old browsers/iframe
                fallbackCopy(textToCopy, copyButton, originalText);
            }
        }

        // --- UI & EVENT HANDLERS (Same as before) ---
        
        /**
         * Opens the Pizza Party Strat Example modal.
         */
        function openExampleModal() {
            document.getElementById('exampleCodeText').textContent = EXAMPLE_CODE;
            document.getElementById('exampleModal').style.display = 'block';
        }

        /**
         * Loads the example code into the input textarea.
         */
        function loadExample() {
            inputCodeTextarea.value = EXAMPLE_CODE;
            // Automatically process the code after loading the example
            processButton.click();
        }

        /**
         * Fills the main cost table with placement costs.
         */
        function populateCostTable() {
            costTableBody.innerHTML = '';
            const isHardcore = hardcoreModeCheckbox.checked;

            const sortedTowerNames = Object.keys(TOWER_COSTS).sort();

            sortedTowerNames.forEach(name => {
                const normalCost = TOWER_COSTS[name]["Place"];
                const hardcoreCost = getHardcoreCost(normalCost);

                const row = document.createElement('tr');
                row.className = 'border-t border-gray-700 hover:bg-gray-700 cursor-pointer';
                row.setAttribute('onclick', `showUpgradeCosts('${name}', ${isHardcore})`);

                row.innerHTML = `
                    <td class="p-2 text-left font-semibold text-green-300">${name}</td>
                    <td class="p-2 text-right">${normalCost.toLocaleString()}</td>
                    <td class="p-2 text-right text-red-400">${hardcoreCost.toLocaleString()}</td>
                `;
                costTableBody.appendChild(row);
            });
        }

        /**
         * Shows the modal with detailed upgrade costs for a selected tower.
         */
        function showUpgradeCosts(towerName, isHardcore) {
            modalTitle.textContent = `${towerName} - Upgrade Costs (${isHardcore ? 'Hardcore' : 'Normal'})`;
            modalTableBody.innerHTML = '';
            const towerData = TOWER_COSTS[towerName];
            
            if (!towerData) return;

            const upgradeLevels = Object.keys(towerData)
                .filter(key => key.startsWith("Upgrade "))
                .sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));

            upgradeLevels.forEach((costType, index) => {
                const normalCost = towerData[costType];
                const hardcoreCost = getHardcoreCost(normalCost);
                const level = index + 1;

                const row = document.createElement('tr');
                row.className = 'border-t border-gray-700';
                row.innerHTML = `
                    <td class="p-2 text-left font-semibold">Level ${level}</td>
                    <td class="p-2 text-right">${normalCost.toLocaleString()}</td>
                    <td class="p-2 text-right text-red-400">${isHardcore ? hardcoreCost.toLocaleString() : '-'}</td>
                `;
                modalTableBody.appendChild(row);
            });

            document.getElementById('upgradeModal').style.display = 'block';
        }

        /**
         * General function to close any modal.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        /**
         * Opens the Source Info modal.
         */
        function openSourceModal() {
            document.getElementById('sourceModal').style.display = 'block';
        }


        window.onload = function() {
            // Get DOM references
            outputTextElement = document.getElementById('outputText');
            processButton = document.getElementById('processButton');
            hardcoreModeCheckbox = document.getElementById('hardcoreMode');
            inputCodeTextarea = document.getElementById('inputCode');
            costTableBody = document.getElementById('costTableBody');
            modalTableBody = document.getElementById('modalTableBody');
            modalTitle = document.getElementById('modalTitle');
            
            // Set up Event Listeners
            processButton.addEventListener('click', () => {
                const inputCode = inputCodeTextarea.value;
                const isHardcore = hardcoreModeCheckbox.checked;
                const result = processCode(inputCode, isHardcore);
                outputTextElement.textContent = result;
                
                populateCostTable(); 
            });

            hardcoreModeCheckbox.addEventListener('change', populateCostTable);
            hardcoreModeCheckbox.addEventListener('change', () => {
                // When Hardcore mode changes, re-process the code to update the total cost
                if(inputCodeTextarea.value.trim() !== "") {
                    processButton.click();
                }
            });


            // Initial population of the cost table
            populateCostTable();
        };

    </script>
</body>
</html>

