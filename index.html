<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunarisX Cost Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #c9d1d9;
            min-height: 100vh;
            
            /* --- N·ªÄN WEB C·ª¶A B·∫†N (CUSTOM BACKGROUND IMAGE) --- */
            background-image: url('https://i.postimg.cc/0Q0DmRmj/lunarisx-logo-description-background-a-deep-space-bla.jpg'); 
            background-size: cover;
            background-attachment: fixed; 
            background-position: center;
            background-color: #0d1117; /* M√†u d·ª± ph√≤ng */
            /* ------------------------------------------------ */
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* ƒêi·ªÅu ch·ªânh m√†u n·ªÅn c·ªßa c√°c box n·ªôi dung ƒë·ªÉ h√¨nh n·ªÅn xuy√™n qua */
        .bg-gray-800 {
            background-color: rgba(31, 41, 55, 0.9); /* Dark Blue/Gray v·ªõi ƒë·ªô trong su·ªët 90% */
            backdrop-filter: blur(2px); /* Hi·ªáu ·ª©ng m·ªù nh·∫π cho n·ªÅn */
        }
        .bg-gray-700, .bg-gray-700\/50, .modal-content {
            background-color: rgba(55, 65, 81, 0.95) !important; 
        }

        /* Custom modal styles for displaying upgrade costs */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            /* ƒê√£ ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh b·∫±ng class .bg-gray-700 ·ªü tr√™n */
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #374151;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        /* Fixed button style */
        #sourceButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 990;
            cursor: pointer;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            border-radius: 9999px; /* Fully rounded */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s;
        }
        #sourceButton:hover {
            background-color: #2563eb; /* Blue 600 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-green-400 mb-6 border-b border-gray-700 pb-2">
            LunarisX Cost Tool
        </h1>
        <p class="text-gray-400 mb-6">
            Tool tracks Tower placement order (Index) and **automatically calculates the current upgrade level** (Level 1, Level 2, etc.) based on the number of `upgradeTower` calls for each Index.
            <br>
            **Supported cost formats (flexible for `cost` keyword):**
            <ul class="list-disc list-inside ml-4 mt-2 text-sm text-gray-300">
                <li>Place: `placeTower(pos, "TowerName", cost)`</li>
                <li>Upgrade: `upgradeTower(<span class="text-red-400">INDEX</span>, cost)`</li>
            </ul>
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Column 1: Input and Settings -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-yellow-400">üìù Input & Settings</h2>

                <!-- Hardcore Mode Toggle -->
                <div class="flex items-center justify-between mb-4 p-3 bg-gray-700 rounded-lg border border-red-500/50">
                    <label for="hardcoreMode" class="text-lg font-bold text-red-400 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Hardcore Mode
                    </label>
                    <input type="checkbox" id="hardcoreMode" class="w-5 h-5 text-red-600 bg-gray-900 border-gray-300 rounded focus:ring-red-500">
                </div>
                
                <label for="inputCode" class="block text-sm font-medium mb-1 text-gray-300">Paste your code (example):</label>
                <textarea id="inputCode" rows="6" placeholder='placeTower(Vec3, "Scout", "cost") -- Index 1
placeTower(Vec3, "Sniper", cost) -- Index 2
upgradeTower(1, cost) -- Scout Lvl 1
upgradeTower(1, "cost") -- Scout Lvl 2
upgradeTower(2, cost) -- Sniper Lvl 1' class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-green-500 focus:border-green-500 mb-4"></textarea>

                <button id="processButton" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold transition duration-200 shadow-md shadow-green-900/50">
                    üîç Lookup & Replace Costs
                </button>
            </div>

            <!-- Column 2: Results -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <!-- N√∫t Copy All ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-blue-400">üí° Results (Modified Code)</h2>
                    <button id="copyButton" onclick="copyOutput()" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition duration-200">
                        Copy All
                    </button>
                </div>
                <!-- K·∫øt th√∫c N√∫t Copy All -->
                
                <div id="outputContainer" class="p-4 bg-gray-700 rounded-lg border border-gray-600 min-h-[16rem]">
                    <pre id="outputText" class="text-sm text-gray-200">Paste your code on the left and press the button to see the result.</pre>
                </div>
            </div>
        </div>

        <!-- Tower Placement Cost Table -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-3 text-red-400">‚ö†Ô∏è Tower Placement Costs (Click Tower Name for Upgrade Details)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm rounded-lg overflow-hidden bg-gray-800">
                    <thead>
                        <tr class="bg-gray-700 text-red-300">
                            <th class="p-2 text-left">Tower</th>
                            <th class="p-2 text-right">Normal Cost</th>
                            <th class="p-2 text-right">Hardcore Cost (x1.5)</th>
                        </tr>
                    </thead>
                    <tbody id="costTableBody">
                        <!-- Data populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Floating Source Button -->
    <div id="sourceButton" onclick="openSourceModal()">
        Source Info
    </div>

    <!-- Modal for Upgrade Costs -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-yellow-400">Tower Upgrade Costs</h3>
                <button onclick="closeModal('upgradeModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <table class="min-w-full text-sm rounded-lg overflow-hidden bg-gray-800">
                <thead>
                    <tr class="bg-gray-700 text-red-300">
                        <th class="p-2 text-left">Level</th>
                        <th class="p-2 text-right">Normal Cost</th>
                        <th class="p-2 text-right">Hardcore Cost</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    <!-- Upgrade data goes here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal for Source Info -->
    <div id="sourceModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 border-gray-600 mb-4">
                <h3 class="text-xl font-bold text-blue-400">Tomato Sauce</h3>
                <button onclick="closeModal('sourceModal')" class="text-gray-400 hover:text-white text-2xl font-bold leading-none">&times;</button>
            </div>
            <p class="text-gray-300 mb-4">This cost replacer tool was created by LunarisX Hub</p>
            <p class="text-gray-300">
                Join Discord
                <a href="#" class="text-blue-400 hover:underline font-semibold" onclick="return false;">https://discord.gg/qfENYnhg</a>
            </p>
        </div>
    </div>


    <script>
        // --- TOWER COST DATA ---
        // Cost data is derived from standard Tower Defense Simulator values, with Trapper modified per user request.
        const TOWER_COSTS = {
            "Scout": { "Place": 150, "Upgrade 1": 50, "Upgrade 2": 200, "Upgrade 3": 950, "Upgrade 4": 2500 },
            "Sniper": { "Place": 300, "Upgrade 1": 150, "Upgrade 2": 500, "Upgrade 3": 1500, "Upgrade 4": 4000 },
            "Paintballer": { "Place": 400, "Upgrade 1": 200, "Upgrade 2": 675, "Upgrade 3": 1000, "Upgrade 4": 2250, "Upgrade 5": 4000 },
            "Demoman": { "Place": 575, "Upgrade 1": 150, "Upgrade 2": 475, "Upgrade 3": 1650, "Upgrade 4": 6250 },
            "Hunter": { "Place": 750, "Upgrade 1": 200, "Upgrade 2": 800, "Upgrade 3": 3250, "Upgrade 4": 9400 },
            "Soldier": { "Place": 350, "Upgrade 1": 100, "Upgrade 2": 400, "Upgrade 3": 1500, "Upgrade 4": 4750 },
            "Militant": { "Place": 700, "Upgrade 1": 200, "Upgrade 2": 900, "Upgrade 3": 2750, "Upgrade 4": 9000 },
            "Freezer": { "Place": 425, "Upgrade 1": 225, "Upgrade 2": 650, "Upgrade 3": 2000, "Upgrade 4": 4500 },
            "Assassin": { "Place": 200, "Upgrade 1": 250, "Upgrade 2": 1000, "Upgrade 3": 2750, "Upgrade 4": 7600 },
            "Shotgunner": { "Place": 300, "Upgrade 1": 150, "Upgrade 2": 950, "Upgrade 3": 2500, "Upgrade 4": 6500 },
            "Pyromancer": { "Place": 850, "Upgrade 1": 350, "Upgrade 2": 950, "Upgrade 3": 1500, "Upgrade 4": 3800, "Upgrade 5": 9000 },
            "Ace Pilot": { "Place": 550, "Upgrade 1": 200, "Upgrade 2": 350, "Upgrade 3": 1850, "Upgrade 4": 3200, "Upgrade 5": 8000 },
            "Medic": { "Place": 500, "Upgrade 1": 500, "Upgrade 2": 750, "Upgrade 3": 2700, "Upgrade 4": 6000, "Upgrade 5": 16000 },
            "Farm": { "Place": 250, "Upgrade 1": 200, "Upgrade 2": 550, "Upgrade 3": 1000, "Upgrade 4": 2500, "Upgrade 5": 5000 },
            "Rocketeer": { "Place": 1500, "Upgrade 1": 250, "Upgrade 2": 1750, "Upgrade 3": 6500, "Upgrade 4": 20000 },
            // --- UPDATED TRAPPER COST ---
            "Trapper": { "Place": 500, "Upgrade 1": 500, "Upgrade 2": 1500, "Upgrade 3": 5000, "Upgrade 4": 13500 },
            // ----------------------------
            "Military Base": { "Place": 400, "Upgrade 1": 200, "Upgrade 2": 400, "Upgrade 3": 1750, "Upgrade 4": 7500, "Upgrade 5": 25000 },
            "Crook Boss": { "Place": 600, "Upgrade 1": 300, "Upgrade 2": 900, "Upgrade 3": 4250, "Upgrade 4": 20000 },
            "Electroshocker": { "Place": 725, "Upgrade 1": 300, "Upgrade 2": 600, "Upgrade 3": 2000, "Upgrade 4": 5000, "Upgrade 5": 15000 },
            "Commander": { "Place": 850, "Upgrade 1": 300, "Upgrade 2": 2500, "Upgrade 3": 5500, "Upgrade 4": 15000 },
            "Warden": { "Place": 1000, "Upgrade 1": 400, "Upgrade 2": 1250, "Upgrade 3": 4500, "Upgrade 4": 15000 },
            "Cowboy": { "Place": 500, "Upgrade 1": 150, "Upgrade 2": 550, "Upgrade 3": 1500, "Upgrade 4": 3000, "Upgrade 5": 5250 },
            "DJ Booth": { "Place": 1200, "Upgrade 1": 300, "Upgrade 2": 1250, "Upgrade 3": 3000, "Upgrade 4": 8000, "Upgrade 5": 20000 },
            "Minigunner": { "Place": 1850, "Upgrade 1": 400, "Upgrade 2": 1500, "Upgrade 3": 7000, "Upgrade 4": 17500 },
            "Ranger": { "Place": 4500, "Upgrade 1": 1500, "Upgrade 2": 4500, "Upgrade 3": 13500, "Upgrade 4": 30000 },
            "Pursuit": { "Place": 3000, "Upgrade 1": 1200, "Upgrade 2": 1850, "Upgrade 3": 5000 },
            "Gatling Gun": { "Place": 5250, "Upgrade 1": 3000, "Upgrade 2": 7500, "Upgrade 3": 15000, "Upgrade 4": 32500, "Upgrade 5": 50000, "Upgrade 6": 100000 },
            "Turret": { "Place": 5000, "Upgrade 1": 1250, "Upgrade 2": 7250, "Upgrade 3": 15000, "Upgrade 4": 30000, "Upgrade 5": 52500 },
            "Mortar": { "Place": 900, "Upgrade 1": 325, "Upgrade 2": 1400, "Upgrade 3": 3250, "Upgrade 4": 12000, "Upgrade 5": 25000 },
            "Mercenary Base": { "Place": 2000, "Upgrade 1": 1000, "Upgrade 2": 2000, "Upgrade 3": 7000, "Upgrade 4": 10000, "Upgrade 5": 15000, "Upgrade 6": 35000 },
            "Brawler": { "Place": 600, "Upgrade 1": 300, "Upgrade 2": 850, "Upgrade 3": 2000, "Upgrade 4": 5000, "Upgrade 5": 12500 },
            "Necromancer": { "Place": 1650, "Upgrade 1": 1150, "Upgrade 2": 3950, "Upgrade 3": 11320, "Upgrade 4": 44000 },
            "Accelerator": { "Place": 4500, "Upgrade 1": 1000, "Upgrade 2": 2500, "Upgrade 3": 4750, "Upgrade 4": 11250, "Upgrade 5": 36000 },
            "Engineer": { "Place": 600, "Upgrade 1": 350, "Upgrade 2": 550, "Upgrade 3": 2250, "Upgrade 4": 4750, "Upgrade 5": 13500, "Upgrade 6": 35000 },
            "Hacker": { "Place": 1400, "Upgrade 1": 600, "Upgrade 2": 1250, "Upgrade 3": 7500, "Upgrade 4": 22000 }
        };

        // Stores the tower name mapped to its placement index (1-based)
        let towerIndexMap = {}; 
        
        // C·∫ßn ph·∫£i l∆∞u tr·ªØ c√°c tham chi·∫øu to√†n c·ª•c ƒë·ªÉ s·ª≠ d·ª•ng trong c√°c h√†m
        let outputTextElement;
        let processButton;
        let hardcoreModeCheckbox;
        let inputCodeTextarea;
        let costTableBody;
        let modalTableBody;
        let modalTitle;


        /**
         * Calculates the Hardcore Cost (1.5x rounded up to the nearest integer).
         * @param {number} baseCost - The normal cost.
         * @returns {number} The hardcore cost.
         */
        const getHardcoreCost = (baseCost) => Math.ceil(baseCost * 1.5); 

        /**
         * Looks up the cost based on tower name and type (Place or Upgrade X).
         * @param {string} towerName - Name of the tower.
         * @param {string} costType - "Place" or "Upgrade X" (where X is the level).
         * @param {boolean} isHardcore - Apply 1.5x multiplier.
         * @returns {number|null} The final cost or null if not found.
         */
        function lookupCost(towerName, costType, isHardcore) {
            const towerData = TOWER_COSTS[towerName];
            if (!towerData) return null;

            const baseCost = towerData[costType];
            if (baseCost === undefined) return null;

            return isHardcore ? getHardcoreCost(baseCost) : baseCost;
        }
        
        // Regex ƒë·ªÉ b·∫Øt l·ªánh placeTower v√† placeholder chi ph√≠ (cost ho·∫∑c "cost")
        const getPlaceRegex = () => {
             // Group 1: (\s*place\s*Tower\s*\([\s\S]*?,\s*['"]) -> Prefix up to tower name's closing quote
             // Group 2: ([^'"]+?) -> Tower Name
             // Group 3: (['"]\s*,\s*) -> Separator after tower name, including its closing quote, and before the cost
             // Group 4: (['"]?([cC][oO][sS][t])['"]?) -> Cost placeholder (quoted or unquoted)
             // Group 5: ([cC][oO][sS][t]) -> inner cost keyword
             // Group 6: (\s*\)) -> Closing parenthesis/suffix
             return /(\s*place\s*Tower\s*\([\s\S]*?,\s*['"])([^'"]+?)(['"]\s*,\s*)(['"]?([cC][oO][sS][t])['"]?)(\s*\))/i;
        };

        // Regex ƒë·ªÉ b·∫Øt l·ªánh upgradeTower v√† placeholder chi ph√≠
        const getUpgradeRegex = () => {
             // Group 1: (\s*upgrade\s*Tower\s*\([\s\S]*?) -> Prefix up to the index
             // Group 2: (\d+) -> Tower Index (e.g., 1)
             // Group 3: (\s*,\s*) -> Separator after index and before cost
             // Group 4: (['"]?([cC][oO][sS][t])['"]?) -> Cost placeholder (quoted or unquoted)
             // Group 5: ([cC][oO][sS][t]) -> inner cost keyword
             // Group 6: (\s*\)) -> Closing parenthesis/suffix
            return /(\s*upgrade\s*Tower\s*\([\s\S]*?)(\d+)(\s*,\s*)(['"]?([cC][oO][sS][t])['"]?)(\s*\))/i;
        };


        /**
         * Pre-scans the input code to map the indexes of placeTower commands to the tower name.
         * This creates the master list of towers placed.
         * @param {string} inputCode - The code string to process.
         */
        function preProcessPlaceCommands(inputCode) {
            towerIndexMap = {};
            let index = 1;
            
            // Regex ch·ªâ ƒë·ªÉ l·∫•y t√™n th√°p
            const preProcessRegex = /(\s*place\s*Tower\s*\([\s\S]*?,\s*['"])([^'"]+?)(['"]\s*,\s*)/i;
            const lines = inputCode.split('\n');

            lines.forEach(line => {
                if (line.toLowerCase().includes('placetower')) {
                    
                    const placeMatch = line.match(preProcessRegex);
                    
                    if (placeMatch) {
                        // T√™n th√°p n·∫±m ·ªü Group 2
                        const towerName = placeMatch[2].trim();
                        if (towerName) {
                            towerIndexMap[index] = towerName;
                            index++;
                        }
                    }
                }
            });
        }

        /**
         * The main function to process the input code string.
         * Handles both placeTower and the new index-based upgradeTower commands (based on call count).
         */
        function processCode(inputCode, isHardcore) {
            
            if (inputCode.trim() === '') {
                 return "‚ùå ERROR: Invalid format. Input cannot be empty.";
            }

            // Step 1: Pre-process the code to map indexes to tower names
            preProcessPlaceCommands(inputCode);
            
            let outputCode = '';
            let matchesFound = 0;
            
            // Map ƒë·ªÉ theo d√µi c·∫•p ƒë·ªô n√¢ng c·∫•p hi·ªán t·∫°i cho m·ªói Index
            const upgradeCounterMap = {}; 
            Object.keys(towerIndexMap).forEach(index => {
                upgradeCounterMap[index] = 0;
            });

            // Regexes defined once
            const placeRegex = getPlaceRegex();
            const upgradeRegex = getUpgradeRegex();

            const lines = inputCode.split('\n');

            lines.forEach(line => {
                let processedLine = line;
                let lineReplaced = false;

                // --- 1. PROCESS placeTower (Thay th·∫ø chi ph√≠ ƒë·∫∑t th√°p) ---
                if (line.toLowerCase().includes('placetower')) {
                    const placeMatch = line.match(placeRegex);
                    
                    if (placeMatch) {
                        const towerName = placeMatch[2].trim(); // T√™n th√°p
                        const finalCost = lookupCost(towerName, "Place", isHardcore);
                        
                        // S·ª≠ d·ª•ng .replace v·ªõi callback ƒë·ªÉ t√°i c·∫•u tr√∫c d√≤ng l·ªánh
                        processedLine = line.replace(placeRegex, (match, prefixToTowerName, towerName, separatorToCost, costPlaceholder, costKeyword, endSuffix) => {
                             if (finalCost !== null) {
                                matchesFound++;
                                lineReplaced = true;
                                // Thay th·∫ø placeholder cost b·∫±ng chi ph√≠ s·ªë (kh√¥ng tr√≠ch d·∫´n)
                                return `${prefixToTowerName}${towerName}${separatorToCost}${finalCost}${endSuffix}`;
                            } else {
                                // Gi·ªØ nguy√™n n·∫øu kh√¥ng t√¨m th·∫•y chi ph√≠
                                console.warn(`[Place] Tower name not found or cost missing: ${towerName}`);
                                return match; 
                            }
                        });
                    }
                }

                // --- 2. PROCESS upgradeTower (Thay th·∫ø chi ph√≠ n√¢ng c·∫•p, theo d√µi c·∫•p ƒë·ªô) ---
                else if (line.toLowerCase().includes('upgradetower')) {
                    const upgradeMatch = line.match(upgradeRegex);

                    if (upgradeMatch) {
                        
                        // Group 2: Tower Index (e.g., 1)
                        const towerIndex = parseInt(upgradeMatch[2], 10);
                        const towerName = towerIndexMap[towerIndex]; 

                        if (towerName) {
                            // TƒÉng b·ªô ƒë·∫øm c·∫•p ƒë·ªô cho Index n√†y (b·∫Øt ƒë·∫ßu t·ª´ 1)
                            upgradeCounterMap[towerIndex] = (upgradeCounterMap[towerIndex] || 0) + 1;
                            const currentLevel = upgradeCounterMap[towerIndex];
                            const costType = `Upgrade ${currentLevel}`;
                            const finalCost = lookupCost(towerName, costType, isHardcore);
                            
                            if (finalCost !== null) {
                                // S·ª≠ d·ª•ng .replace v·ªõi callback ƒë·ªÉ t√°i c·∫•u tr√∫c d√≤ng l·ªánh
                                processedLine = line.replace(upgradeRegex, (match, prefixToTowerIndex, index, separatorToCost, costPlaceholder, costKeyword, endSuffix) => {
                                    matchesFound++;
                                    lineReplaced = true;
                                    // Thay th·∫ø placeholder cost b·∫±ng chi ph√≠ s·ªë (kh√¥ng tr√≠ch d·∫´n)
                                    return `${prefixToTowerIndex}${index}${separatorToCost}${finalCost}${endSuffix}`;
                                });

                            } else {
                                // N·∫øu kh√¥ng t√¨m th·∫•y chi ph√≠ (v√≠ d·ª•: ƒë√£ max level), ho√†n nguy√™n b·ªô ƒë·∫øm v√† c·∫£nh b√°o
                                console.warn(`[Upgrade] Max level reached or cost not defined for ${towerName} (Index ${towerIndex}, Level ${currentLevel}). Leaving 'cost'.`);
                                upgradeCounterMap[towerIndex]--; // Ho√†n nguy√™n b·ªô ƒë·∫øm
                            }
                        } else {
                            console.warn(`[Upgrade] Index ${towerIndex} not found in placement map.`);
                        }
                    }
                }

                outputCode += processedLine + '\n';
            }); // end lines.forEach

            // Final processing/cleanup
            outputCode = outputCode.trim();

            if (matchesFound === 0) {
                 return "‚ö†Ô∏è No 'placeTower' or 'upgradeTower' commands with 'cost' placeholder found.";
            }
            
            return outputCode;
        }

        // --- CLIPBOARD FUNCTIONALITY (Ch·ª©c nƒÉng Sao ch√©p) ---

        /**
         * Fallback mechanism using document.execCommand('copy')
         */
        function fallbackCopy(text, button, originalText) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.left = '-9999px';
            tempTextArea.style.top = '0';

            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    button.textContent = 'ƒê√£ sao ch√©p! ‚úÖ';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 1500);
                } else {
                    button.textContent = 'Th·∫•t b·∫°i ‚ùå';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                }
            } catch (err) {
                button.textContent = 'L·ªói ‚ùå';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }

            document.body.removeChild(tempTextArea);
        }
        
        /**
         * Copies the content of the outputText pre element to the clipboard.
         * Provides user feedback by momentarily changing the button text.
         */
        function copyOutput() {
            const textToCopy = outputTextElement.textContent;
            const copyButton = document.getElementById('copyButton');
            const originalText = 'Copy All';

            if (textToCopy.includes("Paste your code") || textToCopy.includes("No 'placeTower'")) {
                 copyButton.textContent = 'Kh√¥ng c√≥ code ƒë·ªÉ copy!';
                 setTimeout(() => { copyButton.textContent = originalText; }, 2000);
                 return;
            }

            // 1. Th·ª≠ d√πng API clipboard hi·ªán ƒë·∫°i
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        copyButton.textContent = 'ƒê√£ sao ch√©p! ‚úÖ';
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                        }, 1500);
                    })
                    .catch(err => {
                        // 2. Fallback n·∫øu API hi·ªán ƒë·∫°i l·ªói
                        fallbackCopy(textToCopy, copyButton, originalText);
                    });
            } else {
                // 2. Fallback cho tr√¨nh duy·ªát c≈© ho·∫∑c m√¥i tr∆∞·ªùng iframe
                fallbackCopy(textToCopy, copyButton, originalText);
            }
        }

        // --- UI & EVENT HANDLERS ---

        /**
         * Fills the main cost table with placement costs.
         */
        function populateCostTable() {
            costTableBody.innerHTML = '';
            const isHardcore = hardcoreModeCheckbox.checked;

            const sortedTowerNames = Object.keys(TOWER_COSTS).sort();

            sortedTowerNames.forEach(name => {
                const normalCost = TOWER_COSTS[name]["Place"];
                const hardcoreCost = getHardcoreCost(normalCost);

                const row = document.createElement('tr');
                row.className = 'border-t border-gray-700 hover:bg-gray-700 cursor-pointer';
                row.setAttribute('onclick', `showUpgradeCosts('${name}', ${isHardcore})`);

                row.innerHTML = `
                    <td class="p-2 text-left font-semibold text-green-300">${name}</td>
                    <td class="p-2 text-right">${normalCost}</td>
                    <td class="p-2 text-right text-red-400">${hardcoreCost}</td>
                `;
                costTableBody.appendChild(row);
            });
        }

        /**
         * Shows the modal with detailed upgrade costs for a selected tower.
         * @param {string} towerName - Name of the tower.
         * @param {boolean} isHardcore - Current Hardcore setting.
         */
        function showUpgradeCosts(towerName, isHardcore) {
            modalTitle.textContent = `${towerName} - Upgrade Costs (${isHardcore ? 'Hardcore' : 'Normal'})`;
            modalTableBody.innerHTML = '';
            const towerData = TOWER_COSTS[towerName];
            
            if (!towerData) return;

            // L·ªçc ra c√°c chi ph√≠ n√¢ng c·∫•p (b·∫Øt ƒë·∫ßu b·∫±ng "Upgrade ")
            const upgradeLevels = Object.keys(towerData)
                .filter(key => key.startsWith("Upgrade "))
                .sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));

            upgradeLevels.forEach((costType, index) => {
                const normalCost = towerData[costType];
                const hardcoreCost = getHardcoreCost(normalCost);
                const level = index + 1;

                const row = document.createElement('tr');
                row.className = 'border-t border-gray-700';
                row.innerHTML = `
                    <td class="p-2 text-left font-semibold">Level ${level}</td>
                    <td class="p-2 text-right">${normalCost}</td>
                    <td class="p-2 text-right text-red-400">${isHardcore ? hardcoreCost : '-'}</td>
                `;
                modalTableBody.appendChild(row);
            });

            document.getElementById('upgradeModal').style.display = 'block';
        }

        /**
         * General function to close any modal.
         * @param {string} modalId - The ID of the modal to close.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        /**
         * Opens the Source Info modal.
         */
        function openSourceModal() {
            document.getElementById('sourceModal').style.display = 'block';
        }


        window.onload = function() {
            // G√°n c√°c tham chi·∫øu DOM
            outputTextElement = document.getElementById('outputText');
            processButton = document.getElementById('processButton');
            hardcoreModeCheckbox = document.getElementById('hardcoreMode');
            inputCodeTextarea = document.getElementById('inputCode');
            costTableBody = document.getElementById('costTableBody');
            modalTableBody = document.getElementById('modalTableBody');
            modalTitle = document.getElementById('modalTitle');

            // Thi·∫øt l·∫≠p Event Listeners
            processButton.addEventListener('click', () => {
                const inputCode = inputCodeTextarea.value;
                const isHardcore = hardcoreModeCheckbox.checked;
                const result = processCode(inputCode, isHardcore);
                outputTextElement.textContent = result;
                
                // C·∫≠p nh·∫≠t l·∫°i b·∫£ng chi ph√≠ ƒë·∫∑t th√°p ngay c·∫£ khi ch·ªâ nh·∫•n Process
                populateCostTable(); 
            });

            hardcoreModeCheckbox.addEventListener('change', populateCostTable);

            // Kh·ªüi t·∫°o b·∫£ng chi ph√≠ l·∫ßn ƒë·∫ßu
            populateCostTable();
        };

    </script>
</body>
</html>

